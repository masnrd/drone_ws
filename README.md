# masnrd_ws

A ROS workspace for the onboard computer. 

## Installation
Follow the instructions provided [here](https://docs.px4.io/main/en/ros/ros2_comm.html) to install ROS2, PX4-Autopilot, and the MicroXRCEAgent.
- Here are the repositories for reference:
    - [PX4-Autopilot](https://github.com/PX4/PX4-Autopilot). When running the `ubuntu.sh` script as expected, do not include any flags.
    - [MicroXRCEAgent](https://github.com/eProsima/Micro-XRCE-DDS-Agent): Installation steps are [here](https://docs.px4.io/main/en/middleware/uxrce_dds.html).
- You will also need the `PX4-gazebo-models` repository: [PX4-gazebo-models](https://github.com/PX4/PX4-gazebo-models)

Clone this repository along with all submodules:
```
git clone --recursive https://github.com/masnrd/drone_ws.git
```

Install all Python3 dependencies:
```bash
# In the project root (i.e. drone_ws)
python3 -m pip install -r requirements.txt
```
- If you wish to run the UI, run the following command:
    ```bash
    # In the ./frontend directory
    npm install
    ```
- To use the custom world:
    1. Install the default worlds and models:
        ```bash
        python3 simulation-gazebo --overwrite
        ```
    2. Follow the instructions [here](./worlds/README.md) to install the custom worlds used for simulation.

Run the setup script, which updates PX4-Autopilot with the necessary files and generates an `env.sh` file for further usage:
```bash
# In the project root (i.e. drone_ws)
python3 ./setup_env/setup_env.py
```
- **Note**: This automatically sources the necessary ROS2 `setup.bash` and the local installation `setup.bash` files, so sourcing this is all you need when running ROS2 files later on :)
- You **may** need to re-run the `ubuntu.sh` setup file in the `PX4-Autopilot/Tools` directory.

Now, build the ROS2 project.
```bash
# In the project root (i.e. drone_ws)
source /opt/ros/iron/setup.bash
colcon build
```

## Usage
### Setup
Ensure that your PX4 SITL build exists. This command generates a build for the simulated flight controller.
```bash
# In your PX4-Autopilot directory
make px4_sitl
```

### Running Simulation
To ensure communication works, start the Micro XRCE-DDS Agent.
```bash
# In the Micro-XRCE-DDS-Agent directory
MicroXRCEAgent udp4 -p 8888
```

**Server for Drone Simulation**: In a **second** terminal, start the Gazebo server.
```bash
# In the PX4-gazebo-models directory
python3 simulation-gazebo --world SUTD_field
```

**Drone Simulation**: In a **third** terminal, run the launch file, which launches both the necessary simulated flight controllers and the ROS2 drone nodes.
```bash
# In the drone_ws directory
source ./env.sh  # Generated by ./setup_env/setup_env.py
ros2 launch full_launcher drone_launch.py
```


**Mission Control Backend**: In a **fourth** terminal, run the Mission Control backend. This launches the ROS2 node that connects to the drones, and the Flask web server that runs the API backend. 
```bash
# In the drone_ws directory
source ./env.sh  # Generated by ./setup_env/setup_env.py
ros2 run mission_control mission_control_node
```

**Mission Control Frontend**: Finally, in a fifth terminal, run the Mission Control React frontend.
```bash
# In the drone_ws directory
npm start
```
- You can connect to this at `127.0.0.1:3000`. This opens a map showing the locations of each drone.
    - Right now, the simulated field in Gazebo isn't exactly aligned with its position due to its rotation -- hence the position of the simulated drone won't exactly appear to match with the drone on the frontend.
    - Another TODO is to make the React frontend use the environment variable `PX4_HOME_LAT` and `PX4_HOME_LON` to set the start position of the map.
- Clustering can be done at `127.0.0.1:3000/cluster`.
